<!DOCTYPE html>
<html>
  <head>
      <title></title>
      <link rel="stylesheet" href="styles/kendo.common.min.css" />
      <link rel="stylesheet" href="styles/kendo.default.min.css" />
      <link rel="stylesheet" href="styles/kendo.mobile.all.min.css" />

      <script src="js/jquery.min.js"></script>
      <script src="js/kendo.all.min.js"></script>    
  </head>
  
  <body>

    <div data-role="view" data-init="initData"  data-title="進行量測" style="font-family:'Noto Sans TC';" data-use-native-scrolling="true" data-show="kendoViewReady" >

      <div data-role="content" style="
                                  background-color: black;
                                  "> 

        <p style="font-size:18px; color: white; margin:20px">1. 請選擇 身體組成分析儀 所在的健身房</p>

        <div id="店面" class="店面陣列">
<!--
          <a class="" style="font-size: 18px; color: white; background-color:red; padding:10px;border-radius:8px" onclick="selectStore(0)">永和店</a> 
          <a class="" style="font-size: 18px; color: white; background-color:gray; padding:10px;border-radius:8px" onclick="">板橋店</a> 
-->
        </div>           

        <p style="font-size:18px; color: white; margin-left:20px; margin-top: 0px">2. 請按下按鈕，送出測量要求</p>      
        <div style="text-align: center">
          <p id="測量限制" style="font-size:16px; color:gray; text-align:left; margin-left:40px;width:90%">**為讓更多人使用，距離上次量測須超過一小時，才能再度量測，謝謝您的合作</p>         
          <p id="上次測量時間" style="font-size:16px; color:gray; text-align:center">上次測量時間:</p>    
          <button id="開始測量按鈕" class="NotoSansFont" style="font-size: 18px; color: white; background-color:red; padding:10px;border-radius:8px; border-style: none" onclick="送出要求測量()">開始測量</button> 
          <button id="取消測量按鈕" class="NotoSansFont" style="margin-left: 50px; font-size: 18px; color: white; background-color:teal; padding:10px;border-radius:8px; border-style: none" onclick="送出要求測量()">取消測量</button>         
        </div>       
       
        <div id="第三步Div" style="display: none">
          <p style="font-size:18px; color: white; margin:20px; margin-top: 20px">3. 請到 身體組成分析儀 上，進行測量</p> 
          <p id="測量訊息" style="font-size:18px; color: white; margin-left:40px"></p>    
          
          <div id="loadingProgressBar" style="margin-left:20px; margin-right: 20px; width: 90%"></div>                
          
          <div style="height: 20px"></div>
        </div>                
        
        <div id="查看報告Div" style="text-align: center; display: none">
        <div style="height:20px"></div>
        <a class="" style="font-size: 18px; color: white; background-color:red; padding:10px;border-radius:8px" onclick="app.navigate('2-views/量測報告-now.html?reportId=')">查看報告</a> 
        </div>
             
        <div style="height: 50px"></div>     
           
        <!-- Debug on phone -->
        <hr>
        <p id="debug1" style="font-size:14px; color: gray; margin-left:20px"></p>           
        <p id="debug2" style="font-size:14px; color: gray; margin-left:20px"></p>   
               
      </div>     
    </div>
    
    <script>
      var 店面名稱=["永和店", "板橋店", "土城店", "錦州店",
                   "三重店", "松山店", "府中店", "未來店",
                   "未來店"                 
                  ]; // 測試用，之後從 API 取得

      var 機器序號=["T00000001", "T00000002", "T00000003", "T00000004",
                   "T00000005", "T00000006", "T00000007", "T00000008",
                   "T00000009"                 
                  ]; // 測試用，之後從 API 取得      
      
      var 上次使用店面編號 = localStorage.getItem("上次使用店面編號") || 0; // if null then 0
      var 上次量測時間    = localStorage.getItem("上次量測時間") || 0; // if null then 0  
      
      var 上次測量時間Str = (上次量測時間==0)?"2020-01-01T00:00:00+8:00":上次量測時間;
      
      var selectedStoreNum = 上次使用店面編號;
      

      
      function kendoViewReady() {
        console.log( "ready!" );
                
        for (var i=0; i<店面名稱.length;i++) {
          
          var 按鈕顏色 = (i==上次使用店面編號)?"red":"gray";
          // 店面 0, 4, 8, 12, ...
          if (i%3 == 0 || i%3 == 1 ) {
            var storeToadd = '<a id="'+"店面"+i.toString()+'" style="margin-left:20px;font-size: 18px; color: white; background-color:'+按鈕顏色+'; padding:10px;border-radius:8px" onclick="selectStore('+i.toString()+')">'+店面名稱[i]+'</a>';
            //console.log(storeToadd);
            $("#店面").append(storeToadd);        
          } else { // 店面 1,2,5,6
            var storeToadd = '<a id="'+"店面"+i.toString()+'" style="margin-left:20px;font-size: 18px; color: white; background-color:'+按鈕顏色+'; padding:10px;border-radius:8px" onclick="selectStore('+i.toString()+')">'+店面名稱[i]+'</a>';
            $("#店面").append(storeToadd);      
            $("#店面").append("<br><br><br>");             
          }  
        }
        
        var tmpTimeNow     = new Date(toISOStringWithTimeZone());
        var tmpTimeNowInMs = tmpTimeNow.getTime();
        $("#debug1").text("現在時間:" +toISOStringWithTimeZone()+" "+tmpTimeNowInMs.toString());
        
        var tmpTime     = new Date(上次測量時間Str);
        var tmpTimeInMs = tmpTime.getTime();  
        var 轉換時間Array = 上次測量時間Str.split("T");
        var 轉換時間Str   = "上次量測時間: "+轉換時間Array[0]+" "+轉換時間Array[1].substr(0, 轉換時間Array[1].length-6);
        var tmpTimeInMs = (tmpTimeInMs==NaN)? "NaN":"TW";
        
        
        $("#上次測量時間").text(轉換時間Str+"_"+tmpTimeInMs);
        $("#loadingProgressBar").kendoProgressBar({
          animation: 500,
          change: onChange,
          complete: onComplete
        });  
      }
        //aa.progressWrapper.css({"background-color": "#e32424", "border-color": "#e32424"});
        
      function onChange(e) {
        this.progressWrapper.css({"background-color": "#e32424", "border-color": "#e32424"});         
      }
      function onComplete(e) {
        this.progressWrapper.css({"color": "white"});         
        this.progressStatus.text("完成");        
      }      
      
    
      function selectStore(storeNumber){
        console.log("selectStore", storeNumber);
        selectedStoreNum = storeNumber;
        for (var i=0; i<店面名稱.length;i++) {
          if (i==storeNumber) {
            $("#店面"+i.toString()).css("background-color", "red");
          } else {
            $("#店面"+i.toString()).css("background-color", "gray");
          }
        } 
      }
      
      var checkStatusInterval;
      function 送出要求測量(){
        console.log("送出要求測量", selectedStoreNum, 機器序號[selectedStoreNum]);
        
        // 檢查距離上次量測時間
        var tmpTimeNow     = new Date(toISOStringWithTimeZone());
        var tmpTimeNowInMs = tmpTimeNow.getTime();
        $("#debug1").text("現在時間:" +toISOStringWithTimeZone()+" "+tmpTimeNowInMs.toString());
        
        var tmpLastTime     = new Date(上次測量時間Str);
        var tmpLastTimeInMs = tmpLastTime.getTime();  

        
        if ( (tmpTimeNowInMs-tmpLastTimeInMs) < 60000 ) {
          alert("為讓更多人使用，也是保障您的權益，距離上次量測須超過一小時，才能再度量測，謝謝您的合作");
          return;
        }
                
        
        if (confirm("為了您的權益，請檢查是在打鐵健身 "+店面名稱[selectedStoreNum]+" 身體組成分析儀 序號:"+機器序號[selectedStoreNum]+"上進行量測。\n\n序號可在機器上查對")) { 
         $("#開始測量按鈕").attr("disabled", true);
         $("#開始測量按鈕").css("background-color", "gray");           
         $("#第三步Div").show();
         $("#測量訊息").text("接受資料");
         console.log("call API 送出要求測量");

         啟動模擬機();
         $("#loadingProgressBar").data("kendoProgressBar").value(10);
         checkStatusInterval = setInterval( checkMeasurementStatus, 1000);      
           
       } else {
          console.log("放棄測量");
       }
      }  
      
      var measurementStatusMsg="接受資料 ...";
      var measurementStatusMsgBank= [
        "請站上機器", "量測體重 ...", "量測身體組成 50% ...", "量測身體組成 90% ...", "量測身體組成 完成", "資料上傳中 ...", "資料上傳完成"
      ]
      
      function 啟動模擬機(){    
        setTimeout( (() => measurementStatusMsg = measurementStatusMsgBank[0]),  2000);   
        setTimeout( (() => measurementStatusMsg = measurementStatusMsgBank[1]),  4000);   
        setTimeout( (() => measurementStatusMsg = measurementStatusMsgBank[2]),  6000);        
        setTimeout( (() => measurementStatusMsg = measurementStatusMsgBank[3]),  8000);   
        setTimeout( (() => measurementStatusMsg = measurementStatusMsgBank[4]), 10000);   
        setTimeout( (() => measurementStatusMsg = measurementStatusMsgBank[5]), 12000);        
        setTimeout( (() => measurementStatusMsg = measurementStatusMsgBank[6]), 14000);    
        
        //setTimeout( (() => clearInterval(checkStatusInterval)), 14100);           
      }
      
      function toISOStringWithTimeZone() {
          var nowDate = new Date();        
          var tzo = - nowDate.getTimezoneOffset(),
              dif = tzo >= 0 ? '+' : '-',
              pad = function(num) {
                  var norm = Math.floor(Math.abs(num));
                  return (norm < 10 ? '0' : '') + norm;
              };

          return nowDate.getFullYear() +
              '-' + pad(nowDate.getMonth() + 1) +
              '-' + pad(nowDate.getDate()) +
              'T' + pad(nowDate.getHours()) +
              ':' + pad(nowDate.getMinutes()) +
              ':' + pad(nowDate.getSeconds()) +
              dif + pad(tzo / 60) +
              ':' + pad(tzo % 60);
      }
      
      function checkMeasurementStatus(){
        console.log(measurementStatusMsg);
        $("#測量訊息").text(measurementStatusMsg);  
        if (measurementStatusMsg == measurementStatusMsgBank[0]) var pbValue = 20;
        if (measurementStatusMsg == measurementStatusMsgBank[1]) var pbValue = 40;
        if (measurementStatusMsg == measurementStatusMsgBank[2]) var pbValue = 60;
        if (measurementStatusMsg == measurementStatusMsgBank[3]) var pbValue = 70;
        if (measurementStatusMsg == measurementStatusMsgBank[4]) var pbValue = 80;
        if (measurementStatusMsg == measurementStatusMsgBank[5]) var pbValue = 90;        
        if (measurementStatusMsg == measurementStatusMsgBank[6]) var pbValue = 100;            
        
        var pb = $("#loadingProgressBar").data("kendoProgressBar");
        pb.value(pbValue);

        
        if (measurementStatusMsg == measurementStatusMsgBank[measurementStatusMsgBank.length-1]){
          clearInterval(checkStatusInterval);
          console.log("模擬完成");
          var nowDateTimeStr = toISOStringWithTimeZone();
          localStorage.setItem("上次量測時間", nowDateTimeStr);
          localStorage.setItem("上次使用店面編號", selectedStoreNum);
          $("#查看報告Div").show();
        }
      }
      
      
  
      
    </script>
    
    <script>
      //以下必須 remark 掉，不然會有問題
      //var app = new kendo.mobile.Application(document.body, { skin: "nova" });
    </script>

  </body>
</html>